DMACRO IBISTEST
    TM = %1
    LBL(1,30) = "%13" 
    PATT = "%2"
    REG MPAT PC = #0 
    REG MPAT RSET & GOSUB IOO3 
    REG MPAT RSET & GOSUB IBISTEST 
    REG MPAT RTSET & GOSUB TSET
    SEND MPAT POWERUPIBIS
    START MPAT & JUDGE?
    END MPAT 
    IBISCURRENT = 0
    IBISDQSMAX = -9999
    IBISDQSMIN = 9999
     
   ;todo 
    DO GET_CURRENT_EACH_BL BLNUM=1,4,1
        XT15 = #0 
        XT16 = #0
        IF BLNUM =1 THEN XT13 =#EE
        IF BLNUM =2 THEN XT13 =#BB
        IF BLNUM =3 THEN XT13 =#CC 
        IF BLNUM =4 THEN XT13 =#DD 
        ;measure DQ
        SEND MPAT PATT 
        SET WET 
        SET FRUN 
        START MPAT 
        WAIT 100MS
        IF SELIO = "X4"  THEN MEAS!5(DATA4)  : IBISCURRENT & IOCOF = 4, CHOOSEDQS = 3 
        IF SELIO = "X8"  THEN MEAS!5(DATA8)  : IBISCURRENT & IOCOF = 8, CHOOSEDQS = 3 
        IF SELIO = "X16" THEN MEAS!5(DATA16) : IBISCURRENT & IOCOF =16, CHOOSEDQS = 7          
        DO GET_IBISVALUES_DUTLOOPING DDUT = SDUT,EDUT,1
            DO GET_IBISVALUSE_PNLOOPING PN = 1,IOCOF,1
                IVISVALUES(DDUT,BLNUM,PN) = UNIT(IBISCURRENT((DDUT-1)*(IOCONF)+PN)*1000,2)
            GET_IBISVALUSE_PNLOOPING:
            IF IVISVALUES(DDUT,1,1) >0 THEN DUTCOUNT = DUTCOUNT + 1 
        GET_IBISVALUES_DUTLOOPING: 

        ;MEASEURE DQS 
        REG MAPT  PC = #0 
        REG MPAT RSET & GOSUB IBISTEST 
        REG MPAT RTSET & GOSUB TSET
        XT13 =#FF ;1111 1111 FIX 
        
        IF BLNUM =1 THEN PC = #250
        IF BLNUM =2 THEN PC = #300
        IF BLNUM =3 THEN PC = #350
        IF BLNUM =4 THEN PC = #400
        SEND MPAT PATT 
        SET WET 
        SET FRUN 
        START MAPT 
        WAIT 100MS 
        IF SELIO = "X4"  THEN MEAS!5(DQS1 DQS2)             : DQSIBISCURRENT & DQSIOCONF = 2
        IF SELIO = "X8"  THEN MEAS!5(DQS1 DQS2)             : DQSIBISCURRENT & DQSIOCONF = 2
        IF SELIO = "X16"  THEN MEAS!5(DQS1 DQS2 DQS3 DQS4)  : DQSIBISCURRENT & DQSIOCONF = 4

        DO GET_DQSIBISVALUES_DUTLOOPING DDUT = SDUT,EDUT,1
            DO DQSGET_IBISVALUSE_PNLOOPING PN = 1+IOCONF ,IOCOF+DQSIOCONF,1
                IVISVALUES(DDUT,BLNUM,PN) = UNIT(DQSIBISCURRENT((DDUT-1)*(DQSIOCONF)+(PN -IONCOF))*1000,2)
            GET_DQSIBISVALUSE_PNLOOPING:
        GET_DQSIBISVALUES_DUTLOOPING:
       ;TODO
       ;IB$IS VALUE를 만들고 나서? DUTY 값을 구해야한다 BLIBISAVG // DUTY MIN MAX ? // 
       
        DO STORE_IBISVALUEDQS I=1,IOCONF + DQSIOCONF, 1
            IF I<IOCONF+1 THEN IBISVALUEDQS(DDUT,BLNUM,I) = 7.14*IBISVAL(DDUT,BLNUM,PN)
            IF I>IOCONF THEN IBISVALUEDQS(DDUT,BLNUM,I) = IBISVAL(DDUT,BLNUM,PN)   
            IF IBISDQSMAX < IBISVALUEDQS(DDUT,BLNUM,I) THEN IBISDQSMAX(DDUT,BLNUM) = IBISVAL(DDUT,BLNUM,PN)
            IF IBISDQSMIN > IBISVALUEDQS(DDUT,BLNUM,I) THEN IBISDQSMIN(DDUT,BLNUM) = IBISVAL(DUT,BLNUM,PN)             
            BLAVGIBISDQS(DDUT,BLNUM) = BLAVGIBISDQS(DDUT,BLNUM) + IBISVALUEDQS(DDUT,BLNUM,I)
        STORE_IBISVALUEDQS:
        BLAVGIBISDQS(DDUT,BLNUM) = BLAVGIBISDQS(DDUT,BLNUM)/(IOCONF+DQSIOCONF)
        BLAVGALL(DDUT) = BLAVGIBISDQS(DDUT,BLNUM) +DLAVGALL(DDUT)
    GET_CURRENT_EACH_BL:  
    BLAVGALL(DDUT) = BLAVGALL(DDUT)/4

    

        